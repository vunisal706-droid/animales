<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>CapitulÃ­n - Aventura en la Selva</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }

        #root {
            width: 100%;
            height: 100%;
        }

        .touch-controls {
            position: fixed;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 200;
            pointer-events: none;
        }

        .touch-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            border: 3px solid #2C5F2D;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            user-select: none;
            pointer-events: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .touch-btn:active {
            background: rgba(200, 255, 200, 0.9);
            transform: scale(0.95);
        }

        .left-controls {
            display: flex;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .touch-btn {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Sistema de sonido
        const SoundSystem = {
          audioContext: null,
          
          init() {
            if (!this.audioContext) {
              try {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
              } catch(e) {
                console.log('Audio no disponible');
              }
            }
          },

          playSuccess() {
            try {
              this.init();
              if (!this.audioContext) return;
              
              const oscillator = this.audioContext.createOscillator();
              const gainNode = this.audioContext.createGain();
              
              oscillator.connect(gainNode);
              gainNode.connect(this.audioContext.destination);
              
              oscillator.frequency.value = 523.25;
              oscillator.type = 'sine';
              
              gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
              
              oscillator.start(this.audioContext.currentTime);
              oscillator.stop(this.audioContext.currentTime + 0.5);
            } catch(e) {}
          },

          playCollect() {
            try {
              this.init();
              if (!this.audioContext) return;
              
              const oscillator = this.audioContext.createOscillator();
              const gainNode = this.audioContext.createGain();
              
              oscillator.connect(gainNode);
              gainNode.connect(this.audioContext.destination);
              
              oscillator.frequency.value = 800;
              oscillator.type = 'square';
              
              gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
              
              oscillator.start(this.audioContext.currentTime);
              oscillator.stop(this.audioContext.currentTime + 0.2);
            } catch(e) {}
          }
        };

        // FunciÃ³n para dibujar personaje
        const drawCharacter = (ctx, x, y, costume, scale = 1) => {
          ctx.save();
          ctx.translate(x, y);
          ctx.scale(scale, scale);

          let bodyColor = '#FFD700';
          let headColor = '#FFDAB9';
          let showCape = false;
          let capeColor = '';
          let showHammer = false;
          let showCircle = false;
          let circleColor = '';

          switch(costume) {
            case 'superman':
              bodyColor = '#0047AB';
              showCape = true;
              capeColor = '#DC143C';
              showCircle = true;
              circleColor = '#DC143C';
              break;
            case 'batman':
              bodyColor = '#2C2C2C';
              showCape = true;
              capeColor = '#000000';
              showCircle = true;
              circleColor = '#FFD700';
              break;
            case 'spiderman':
              bodyColor = '#DC143C';
              headColor = '#DC143C';
              showCircle = true;
              circleColor = '#000000';
              break;
            case 'hulk':
              bodyColor = '#228B22';
              headColor = '#228B22';
              break;
            case 'thor':
              bodyColor = '#4169E1';
              showHammer = true;
              break;
            case 'ironman':
              bodyColor = '#DC143C';
              headColor = '#FFD700';
              break;
            case 'mario':
              bodyColor = '#FF0000';
              break;
          }

          // Capa
          if (showCape) {
            ctx.fillStyle = capeColor;
            ctx.beginPath();
            ctx.moveTo(5, 10);
            ctx.lineTo(-5, 10);
            ctx.lineTo(-8, 25);
            ctx.lineTo(8, 25);
            ctx.closePath();
            ctx.fill();
          }

          // Piernas
          ctx.fillStyle = '#4169E1';
          ctx.fillRect(-4, 20, 3, 12);
          ctx.fillRect(1, 20, 3, 12);

          // Zapatos
          ctx.fillStyle = '#8B4513';
          ctx.fillRect(-5, 32, 4, 3);
          ctx.fillRect(1, 32, 4, 3);

          // Cuerpo
          ctx.fillStyle = bodyColor;
          ctx.fillRect(-6, 8, 12, 14);

          // CÃ­rculo en pecho
          if (showCircle) {
            ctx.fillStyle = circleColor;
            ctx.beginPath();
            ctx.arc(0, 15, 3, 0, Math.PI * 2);
            ctx.fill();
          }

          // Brazos
          ctx.fillStyle = bodyColor;
          ctx.fillRect(-8, 10, 2, 10);
          ctx.fillRect(6, 10, 2, 10);

          // Manos
          ctx.fillStyle = headColor;
          ctx.beginPath();
          ctx.arc(-7, 20, 2, 0, Math.PI * 2);
          ctx.fill();
          ctx.beginPath();
          ctx.arc(7, 20, 2, 0, Math.PI * 2);
          ctx.fill();

          // Martillo
          if (showHammer) {
            ctx.fillStyle = '#808080';
            ctx.fillRect(8, 18, 2, 8);
            ctx.fillStyle = '#C0C0C0';
            ctx.fillRect(6, 16, 6, 4);
          }

          // Cabeza
          ctx.fillStyle = headColor;
          ctx.beginPath();
          ctx.arc(0, 4, 6, 0, Math.PI * 2);
          ctx.fill();

          // Pelo moreno
          if (costume !== 'spiderman' && costume !== 'hulk' && costume !== 'ironman') {
            ctx.fillStyle = '#3D2817';
            ctx.beginPath();
            ctx.ellipse(0, -1, 7, 4, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(-4, 0, 3, 0, Math.PI);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(4, 0, 3, 0, Math.PI);
            ctx.fill();
          }

          // Ojos
          if (costume === 'ironman') {
            ctx.fillStyle = '#00FFFF';
            ctx.fillRect(-3, 2, 2, 2);
            ctx.fillRect(1, 2, 2, 2);
          } else {
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(-2, 3, 1, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(2, 3, 1, 0, Math.PI * 2);
            ctx.fill();
          }

          // Sonrisa
          ctx.strokeStyle = '#000000';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.arc(0, 5, 3, 0, Math.PI);
          ctx.stroke();

          // Gorra Mario
          if (costume === 'mario') {
            ctx.fillStyle = '#FF0000';
            ctx.fillRect(-6, -2, 12, 3);
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(0, -1, 2, 0, Math.PI * 2);
            ctx.fill();
          }

          ctx.restore();
        };

        const LEVELS = {
          level1: {
            platforms: [
              { x: 0, y: 450, width: 800, height: 50 },
              { x: 100, y: 350, width: 120, height: 20 },
              { x: 350, y: 300, width: 140, height: 20 },
              { x: 600, y: 350, width: 130, height: 20 },
              { x: 150, y: 200, width: 100, height: 20 },
              { x: 500, y: 150, width: 110, height: 20 }
            ],
            background: 'linear-gradient(to bottom, #87CEEB, #90EE90)',
            platformColor: '#8B4513'
          },
          level2: {
            platforms: [
              { x: 0, y: 450, width: 800, height: 50 },
              { x: 50, y: 380, width: 100, height: 20 },
              { x: 250, y: 320, width: 120, height: 20 },
              { x: 500, y: 380, width: 100, height: 20 },
              { x: 680, y: 320, width: 100, height: 20 },
              { x: 300, y: 200, width: 150, height: 20 },
              { x: 100, y: 150, width: 100, height: 20 }
            ],
            background: 'linear-gradient(to bottom, #FFB6C1, #FFE4E1)',
            platformColor: '#CD853F'
          },
          level3: {
            platforms: [
              { x: 0, y: 450, width: 800, height: 50 },
              { x: 200, y: 370, width: 130, height: 20 },
              { x: 450, y: 300, width: 120, height: 20 },
              { x: 100, y: 250, width: 110, height: 20 },
              { x: 600, y: 250, width: 120, height: 20 },
              { x: 350, y: 170, width: 100, height: 20 },
              { x: 50, y: 120, width: 100, height: 20 }
            ],
            background: 'linear-gradient(to bottom, #E0BBE4, #FEC8D8)',
            platformColor: '#A0522D'
          },
          level4: {
            platforms: [
              { x: 0, y: 450, width: 800, height: 50 },
              { x: 650, y: 380, width: 130, height: 20 },
              { x: 400, y: 340, width: 120, height: 20 },
              { x: 150, y: 300, width: 110, height: 20 },
              { x: 550, y: 240, width: 100, height: 20 },
              { x: 250, y: 180, width: 130, height: 20 },
              { x: 500, y: 120, width: 100, height: 20 }
            ],
            background: 'linear-gradient(to bottom, #B4F8C8, #FBE7C6)',
            platformColor: '#8B6914'
          },
          level5: {
            platforms: [
              { x: 0, y: 450, width: 800, height: 50 },
              { x: 120, y: 390, width: 100, height: 20 },
              { x: 320, y: 350, width: 140, height: 20 },
              { x: 580, y: 300, width: 120, height: 20 },
              { x: 180, y: 240, width: 110, height: 20 },
              { x: 450, y: 180, width: 100, height: 20 },
              { x: 650, y: 150, width: 100, height: 20 }
            ],
            background: 'linear-gradient(to bottom, #A8E6CF, #FFD3B6)',
            platformColor: '#704214'
          }
        };

        const CapitulinGame = () => {
          const [screen, setScreen] = useState('start');
          const [gameMode, setGameMode] = useState(null);
          const [currentLevel, setCurrentLevel] = useState(1);
          const [totalAnimalsFreed, setTotalAnimalsFreed] = useState(0);
          const [coins, setCoins] = useState(0);
          const [currentCostume, setCurrentCostume] = useState('default');
          const [ownedCostumes, setOwnedCostumes] = useState(['default']);
          const [showQuestion, setShowQuestion] = useState(false);
          const [currentAnimal, setCurrentAnimal] = useState(null);
          const [showFeedback, setShowFeedback] = useState(null);
          const [playerPos, setPlayerPos] = useState({ x: 50, y: 300 });
          const [velocity, setVelocity] = useState({ x: 0, y: 0 });
          const [isJumping, setIsJumping] = useState(false);
          const [cagePositions, setCagePositions] = useState([]);
          const [showLevelComplete, setShowLevelComplete] = useState(false);
          const [usedAnimals, setUsedAnimals] = useState([]);
          const keysPressed = useRef({});
          const touchControls = useRef({ left: false, right: false, jump: false });
          const gameLoopRef = useRef(null);
          const canvasRef = useRef(null);

          const allAnimals = [
            { name: 'ğŸ• Perro', domestic: 'domestico', habitat: 'terrestre', diet: 'omnivoro' },
            { name: 'ğŸˆ Gato', domestic: 'domestico', habitat: 'terrestre', diet: 'carnivoro' },
            { name: 'ğŸ„ Vaca', domestic: 'domestico', habitat: 'terrestre', diet: 'herbivoro' },
            { name: 'ğŸ´ Caballo', domestic: 'domestico', habitat: 'terrestre', diet: 'herbivoro' },
            { name: 'ğŸ¦ LeÃ³n', domestic: 'salvaje', habitat: 'terrestre', diet: 'carnivoro' },
            { name: 'ğŸ¯ Tigre', domestic: 'salvaje', habitat: 'terrestre', diet: 'carnivoro' },
            { name: 'ğŸ˜ Elefante', domestic: 'salvaje', habitat: 'terrestre', diet: 'herbivoro' },
            { name: 'ğŸ¦’ Jirafa', domestic: 'salvaje', habitat: 'terrestre', diet: 'herbivoro' },
            { name: 'ğŸ» Oso', domestic: 'salvaje', habitat: 'terrestre', diet: 'omnivoro' },
            { name: 'ğŸ¬ DelfÃ­n', domestic: 'salvaje', habitat: 'acuatico', diet: 'carnivoro' },
            { name: 'ğŸ¦ˆ TiburÃ³n', domestic: 'salvaje', habitat: 'acuatico', diet: 'carnivoro' },
            { name: 'ğŸ  Pez', domestic: 'salvaje', habitat: 'acuatico', diet: 'omnivoro' },
            { name: 'ğŸ¦… Ãguila', domestic: 'salvaje', habitat: 'aereo', diet: 'carnivoro' },
            { name: 'ğŸ¦œ Loro', domestic: 'salvaje', habitat: 'aereo', diet: 'omnivoro' },
            { name: 'ğŸ¦‰ BÃºho', domestic: 'salvaje', habitat: 'aereo', diet: 'carnivoro' },
            { name: 'ğŸ” Gallina', domestic: 'domestico', habitat: 'terrestre', diet: 'omnivoro' },
            { name: 'ğŸ¦† Pato', domestic: 'domestico', habitat: 'acuatico', diet: 'omnivoro' },
            { name: 'ğŸµ Mono', domestic: 'salvaje', habitat: 'terrestre', diet: 'omnivoro' },
            { name: 'ğŸ· Cerdo', domestic: 'domestico', habitat: 'terrestre', diet: 'omnivoro' },
            { name: 'ğŸ° Conejo', domestic: 'domestico', habitat: 'terrestre', diet: 'herbivoro' },
            { name: 'ğŸº Lobo', domestic: 'salvaje', habitat: 'terrestre', diet: 'carnivoro' },
            { name: 'ğŸ¦Š Zorro', domestic: 'salvaje', habitat: 'terrestre', diet: 'omnivoro' },
            { name: 'ğŸ¦Œ Ciervo', domestic: 'salvaje', habitat: 'terrestre', diet: 'herbivoro' },
            { name: 'ğŸ¸ Rana', domestic: 'salvaje', habitat: 'acuatico', diet: 'carnivoro' },
            { name: 'ğŸ¢ Tortuga', domestic: 'salvaje', habitat: 'acuatico', diet: 'omnivoro' },
            { name: 'ğŸŠ Cocodrilo', domestic: 'salvaje', habitat: 'acuatico', diet: 'carnivoro' },
            { name: 'ğŸ¦ Lagarto', domestic: 'salvaje', habitat: 'terrestre', diet: 'carnivoro' },
            { name: 'ğŸ¦˜ Canguro', domestic: 'salvaje', habitat: 'terrestre', diet: 'herbivoro' },
            { name: 'ğŸ¦¡ TejÃ³n', domestic: 'salvaje', habitat: 'terrestre', diet: 'omnivoro' },
            { name: 'ğŸ€ RatÃ³n', domestic: 'salvaje', habitat: 'terrestre', diet: 'omnivoro' }
          ];

          const costumes = [
            { id: 'default', name: 'CapitulÃ­n', price: 0 },
            { id: 'superman', name: 'Superman', price: 5 },
            { id: 'spiderman', name: 'Spiderman', price: 5 },
            { id: 'hulk', name: 'Hulk', price: 5 },
            { id: 'thor', name: 'Thor', price: 5 },
            { id: 'mario', name: 'Mario Bros', price: 5 },
            { id: 'batman', name: 'Batman', price: 5 },
            { id: 'ironman', name: 'Iron Man', price: 5 }
          ];

          const getCurrentLevelData = () => {
            const levelKey = `level${currentLevel}`;
            return LEVELS[levelKey] || LEVELS.level1;
          };

          const drawTree = (ctx, x, y) => {
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x, y, 8, 20);
            ctx.fillStyle = '#228B22';
            ctx.beginPath();
            ctx.arc(x + 4, y, 12, 0, Math.PI * 2);
            ctx.fill();
          };

          const drawCloud = (ctx, x, y) => {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.beginPath();
            ctx.arc(x, y, 15, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 15, y, 20, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 30, y, 15, 0, Math.PI * 2);
            ctx.fill();
          };

          useEffect(() => {
            if (screen === 'game' && cagePositions.length === 0) {
              generateCages();
            }
          }, [screen, currentLevel]);

          useEffect(() => {
            if (screen === 'game' && !showQuestion && !showLevelComplete) {
              gameLoopRef.current = setInterval(() => {
                updateGame();
              }, 1000 / 60);

              return () => {
                if (gameLoopRef.current) {
                  clearInterval(gameLoopRef.current);
                }
              };
            }
          }, [screen, showQuestion, showLevelComplete, playerPos.x, playerPos.y, velocity.y, isJumping]);

          useEffect(() => {
            const handleKeyDown = (e) => {
              keysPressed.current[e.key] = true;
              if ((e.key === 'ArrowUp' || e.key === ' ') && !isJumping && !showQuestion && !showLevelComplete) {
                setVelocity(v => ({ ...v, y: -15 }));
                setIsJumping(true);
              }
            };

            const handleKeyUp = (e) => {
              keysPressed.current[e.key] = false;
            };

            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('keyup', handleKeyUp);

            return () => {
              window.removeEventListener('keydown', handleKeyDown);
              window.removeEventListener('keyup', handleKeyUp);
            };
          }, [isJumping, showQuestion, showLevelComplete]);

          const generateCages = () => {
            const levelData = getCurrentLevelData();
            const newCages = levelData.platforms.slice(1).map((platform, idx) => ({
              x: platform.x + platform.width / 2 - 20,
              y: platform.y - 45,
              collected: false,
              id: idx
            }));
            setCagePositions(newCages);
          };

          const getRandomAnimal = () => {
            const availableAnimals = allAnimals.filter(animal => !usedAnimals.includes(animal.name));
            
            if (availableAnimals.length === 0) {
              setUsedAnimals([]);
              return allAnimals[Math.floor(Math.random() * allAnimals.length)];
            }
            
            const randomAnimal = availableAnimals[Math.floor(Math.random() * availableAnimals.length)];
            setUsedAnimals([...usedAnimals, randomAnimal.name]);
            return randomAnimal;
          };

          const updateGame = () => {
            const levelData = getCurrentLevelData();
            
            setPlayerPos(prev => {
              let newX = prev.x;

              if (keysPressed.current['ArrowLeft'] || touchControls.current.left) {
                newX -= 5;
              }
              if (keysPressed.current['ArrowRight'] || touchControls.current.right) {
                newX += 5;
              }

              newX = Math.max(0, Math.min(770, newX));

              return { ...prev, x: newX };
            });

            setVelocity(prev => {
              let newVelY = prev.y + 0.6;
              
              levelData.platforms.forEach(platform => {
                if (
                  playerPos.x + 20 > platform.x &&
                  playerPos.x - 20 < platform.x + platform.width &&
                  playerPos.y + 45 >= platform.y &&
                  playerPos.y + 45 <= platform.y + 20 &&
                  newVelY >= 0
                ) {
                  newVelY = 0;
                  setPlayerPos(p => ({ ...p, y: platform.y - 45 }));
                  setIsJumping(false);
                }
              });

              return { ...prev, y: newVelY };
            });

            setPlayerPos(prev => ({
              ...prev,
              y: Math.min(prev.y + velocity.y, 455)
            }));

            cagePositions.forEach(cage => {
              if (
                !cage.collected &&
                Math.abs(playerPos.x - cage.x - 20) < 40 &&
                Math.abs(playerPos.y - cage.y - 20) < 40
              ) {
                collectCage(cage.id);
              }
            });

            const allCollected = cagePositions.every(cage => cage.collected);
            if (allCollected && cagePositions.length > 0 && !showLevelComplete) {
              completeLevel();
            }
          };

          const collectCage = (cageId) => {
            SoundSystem.playCollect();

            setCagePositions(prev =>
              prev.map(cage =>
                cage.id === cageId ? { ...cage, collected: true } : cage
              )
            );

            const randomAnimal = getRandomAnimal();
            setCurrentAnimal(randomAnimal);
            setShowQuestion(true);
          };

          const completeLevel = () => {
            setShowLevelComplete(true);
            setUsedAnimals([]);
          };

          const nextLevel = () => {
            if (currentLevel < 5) {
              setCurrentLevel(currentLevel + 1);
              setPlayerPos({ x: 50, y: 300 });
              setVelocity({ x: 0, y: 0 });
              setIsJumping(false);
              setCagePositions([]);
              setShowLevelComplete(false);
            } else {
              alert('Â¡Felicidades! Â¡Has completado todos los niveles!');
              resetGame();
              setScreen('menu');
            }
          };

          const handleAnswer = (answer) => {
            let correct = false;
            let correctAnswer = '';

            if (gameMode === 'domestic') {
              correct = answer === currentAnimal.domestic;
              correctAnswer = currentAnimal.domestic;
            } else if (gameMode === 'habitat') {
              correct = answer === currentAnimal.habitat;
              correctAnswer = currentAnimal.habitat;
            } else if (gameMode === 'diet') {
              correct = answer === currentAnimal.diet;
              correctAnswer = currentAnimal.diet;
            }

            if (correct) {
              SoundSystem.playSuccess();
              setShowFeedback('correct');
              setCoins(c => c + 1);
              setTotalAnimalsFreed(t => t + 1);
              
              setTimeout(() => {
                setShowFeedback(null);
                setShowQuestion(false);
                setCurrentAnimal(null);
              }, 1500);
            } else {
              setShowFeedback({ type: 'incorrect', correct: correctAnswer });
              
              setTimeout(() => {
                setShowFeedback(null);
                setShowQuestion(false);
                setCurrentAnimal(null);
              }, 3000);
            }
          };

          const buyCostume = (costumeId) => {
            const costume = costumes.find(c => c.id === costumeId);
            if (coins >= costume.price && !ownedCostumes.includes(costumeId)) {
              setCoins(c => c - costume.price);
              setOwnedCostumes([...ownedCostumes, costumeId]);
              setCurrentCostume(costumeId);
            } else if (ownedCostumes.includes(costumeId)) {
              setCurrentCostume(costumeId);
            }
          };

          const getOptionLabel = (mode, option) => {
            if (mode === 'domestic') {
              return option === 'domestico' ? 'DomÃ©stico' : 'Salvaje';
            } else if (mode === 'habitat') {
              if (option === 'terrestre') return 'Terrestre';
              if (option === 'acuatico') return 'AcuÃ¡tico';
              if (option === 'aereo') return 'AÃ©reo';
            } else if (mode === 'diet') {
              if (option === 'herbivoro') return 'HerbÃ­voro';
              if (option === 'carnivoro') return 'CarnÃ­voro';
              if (option === 'omnivoro') return 'OmnÃ­voro';
            }
          };

          const resetGame = () => {
            setCurrentLevel(1);
            setPlayerPos({ x: 50, y: 300 });
            setVelocity({ x: 0, y: 0 });
            setIsJumping(false);
            setCagePositions([]);
            setShowQuestion(false);
            setCurrentAnimal(null);
            setShowFeedback(null);
            setShowLevelComplete(false);
            setUsedAnimals([]);
          };

          const handleJump = () => {
            if (!isJumping && !showQuestion && !showLevelComplete) {
              setVelocity(v => ({ ...v, y: -15 }));
              setIsJumping(true);
            }
          };

          useEffect(() => {
            if (screen === 'game' && canvasRef.current) {
              const canvas = canvasRef.current;
              const ctx = canvas.getContext('2d');
              
              ctx.clearRect(0, 0, canvas.width, canvas.height);

              const levelData = getCurrentLevelData();

              // Nubes
              drawCloud(ctx, 100, 50);
              drawCloud(ctx, 400, 80);
              drawCloud(ctx, 650, 40);

              // Plataformas
              ctx.fillStyle = levelData.platformColor;
              levelData.platforms.forEach(platform => {
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 2;
                ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
              });

              // Ãrboles
              drawTree(ctx, 50, 410);
              drawTree(ctx, 700, 410);
              drawTree(ctx, 300, 410);

              // Cajas
              cagePositions.forEach(cage => {
                if (!cage.collected) {
                  ctx.font = '40px Arial';
                  ctx.fillText('ğŸ“¦', cage.x, cage.y + 35);
                }
              });

              // Personaje
              drawCharacter(ctx, playerPos.x, playerPos.y, currentCostume, 1.5);
            }
          });

          if (screen === 'start') {
            return (
              <div style={{
                width: '100vw',
                height: '100vh',
                background: 'linear-gradient(to bottom, #87CEEB, #90EE90)',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                fontFamily: 'Arial, sans-serif',
                padding: '20px'
              }}>
                <div style={{ fontSize: 'clamp(3rem, 15vw, 5rem)', marginBottom: '20px' }}>ğŸ§’</div>
                <h1 style={{ fontSize: 'clamp(2rem, 8vw, 3rem)', color: '#2C5F2D', textShadow: '3px 3px #FFD700', marginBottom: '10px', textAlign: 'center' }}>
                  CAPITULÃN
                </h1>
                <h2 style={{ fontSize: 'clamp(1rem, 4vw, 1.5rem)', color: '#FF6347', marginBottom: '40px', textAlign: 'center' }}>
                  Aventura en la Selva
                </h2>
                <button
                  onClick={() => setScreen('menu')}
                  style={{
                    fontSize: 'clamp(1.5rem, 5vw, 2rem)',
                    padding: '20px 60px',
                    backgroundColor: '#FF6347',
                    color: 'white',
                    border: 'none',
                    borderRadius: '20px',
                    cursor: 'pointer',
                    fontWeight: 'bold',
                    boxShadow: '0 8px #C04030'
                  }}
                >
                  Â¡JUGAR! ğŸ®
                </button>
              </div>
            );
          }

          if (screen === 'menu') {
            return (
              <div style={{
                width: '100vw',
                height: '100vh',
                background: 'linear-gradient(to bottom, #87CEEB, #90EE90)',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                fontFamily: 'Arial, sans-serif',
                padding: '20px'
              }}>
                <h2 style={{ fontSize: 'clamp(1.5rem, 6vw, 2.5rem)', color: '#2C5F2D', marginBottom: '40px', textAlign: 'center' }}>
                  Elige tu Aventura
                </h2>
                
                <button
                  onClick={() => { setGameMode('domestic'); resetGame(); setScreen('game'); }}
                  style={{
                    fontSize: 'clamp(1rem, 4vw, 1.5rem)',
                    padding: '20px 40px',
                    margin: '15px',
                    backgroundColor: '#FFD700',
                    color: '#2C5F2D',
                    border: '4px solid #FFA500',
                    borderRadius: '15px',
                    cursor: 'pointer',
                    fontWeight: 'bold',
                    width: '90%',
                    maxWidth: '500px'
                  }}
                >
                  ğŸ  vs ğŸŒ´ DomÃ©sticos o Salvajes
                </button>

                <button
                  onClick={() => { setGameMode('habitat'); resetGame(); setScreen('game'); }}
                  style={{
                    fontSize: 'clamp(1rem, 4vw, 1.5rem)',
                    padding: '20px 40px',
                    margin: '15px',
                    backgroundColor: '#87CEEB',
                    color: '#2C5F2D',
                    border: '4px solid #4682B4',
                    borderRadius: '15px',
                    cursor: 'pointer',
                    fontWeight: 'bold',
                    width: '90%',
                    maxWidth: '500px'
                  }}
                >
                  ğŸš— ğŸš¢ âœˆï¸ Terrestre, AcuÃ¡tico o AÃ©reo
                </button>

                <button
                  onClick={() => { setGameMode('diet'); resetGame(); setScreen('game'); }}
                  style={{
                    fontSize: 'clamp(1rem, 4vw, 1.5rem)',
                    padding: '20px 40px',
                    margin: '15px',
                    backgroundColor: '#90EE90',
                    color: '#2C5F2D',
                    border: '4px solid #228B22',
                    borderRadius: '15px',
                    cursor: 'pointer',
                    fontWeight: 'bold',
                    width: '90%',
                    maxWidth: '500px'
                  }}
                >
                  ğŸŒ± ğŸ¥© ğŸ” HerbÃ­voro, CarnÃ­voro u OmnÃ­voro
                </button>

                <div style={{ display: 'flex', gap: '10px', marginTop: '30px' }}>
                  <button
                    onClick={() => setScreen('stats')}
                    style={{
                      fontSize: 'clamp(0.9rem, 3vw, 1.2rem)',
                      padding: '15px 30px',
                      backgroundColor: '#FF69B4',
                      color: 'white',
                      border: 'none',
                      borderRadius: '10px',
                      cursor: 'pointer',
                      fontWeight: 'bold'
                    }}
                  >
                    ğŸ“Š EstadÃ­sticas
                  </button>

                  <button
                    onClick={() => setScreen('shop')}
                    style={{
                      fontSize: 'clamp(0.9rem, 3vw, 1.2rem)',
                      padding: '15px 30px',
                      backgroundColor: '#FFA500',
                      color: 'white',
                      border: 'none',
                      borderRadius: '10px',
                      cursor: 'pointer',
                      fontWeight: 'bold'
                    }}
                  >
                    ğŸ›ï¸ Tienda
                  </button>
                </div>
              </div>
            );
          }

          if (screen === 'stats') {
            return (
              <div style={{
                width: '100vw',
                height: '100vh',
                background: 'linear-gradient(to bottom, #FFE4E1, #FFF0F5)',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                fontFamily: 'Arial, sans-serif',
                padding: '20px'
              }}>
                <h2 style={{ fontSize: 'clamp(1.5rem, 6vw, 2.5rem)', color: '#FF1493', marginBottom: '30px', textAlign: 'center' }}>
                  ğŸ“Š EstadÃ­sticas
                </h2>
                
                <div style={{
                  backgroundColor: 'white',
                  padding: '30px',
                  borderRadius: '20px',
                  boxShadow: '0 4px 8px rgba(0,0,0,0.2)',
                  minWidth: '80%',
                  maxWidth: '400px'
                }}>
                  <p style={{ fontSize: 'clamp(1.2rem, 4vw, 1.8rem)', margin: '20px 0', color: '#333' }}>
                    ğŸ¦ Animales liberados: <strong>{totalAnimalsFreed}</strong>
                  </p>
                  <p style={{ fontSize: 'clamp(1.2rem, 4vw, 1.8rem)', margin: '20px 0', color: '#333' }}>
                    ğŸ­ Trajes: <strong>{ownedCostumes.length}/8</strong>
                  </p>
                  <p style={{ fontSize: 'clamp(1.2rem, 4vw, 1.8rem)', margin: '20px 0', color: '#333' }}>
                    ğŸª™ Monedas: <strong>{coins}</strong>
                  </p>
                </div>

                <button
                  onClick={() => setScreen('menu')}
                  style={{
                    fontSize: 'clamp(1rem, 4vw, 1.5rem)',
                    padding: '15px 40px',
                    marginTop: '40px',
                    backgroundColor: '#FF69B4',
                    color: 'white',
                    border: 'none',
                    borderRadius: '15px',
                    cursor: 'pointer',
                    fontWeight: 'bold'
                  }}
                >
                  â¬…ï¸ Volver
                </button>
              </div>
            );
          }

          if (screen === 'shop') {
            return (
              <div style={{
                width: '100vw',
                height: '100vh',
                background: 'linear-gradient(to bottom, #FFE4B5, #FFDAB9)',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'flex-start',
                fontFamily: 'Arial, sans-serif',
                padding: '20px',
                overflowY: 'auto'
              }}>
                <h2 style={{ fontSize: 'clamp(1.5rem, 6vw, 2.5rem)', color: '#8B4513', marginBottom: '20px', textAlign: 'center' }}>
                  ğŸ›ï¸ Tienda
                </h2>
                <p style={{ fontSize: 'clamp(1rem, 4vw, 1.5rem)', color: '#D2691E', marginBottom: '30px' }}>
                  ğŸª™ {coins} monedas
                </p>

                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
                  gap: '15px',
                  width: '100%',
                  maxWidth: '600px',
                  marginBottom: '20px'
                }}>
                  {costumes.map(costume => {
                    const owned = ownedCostumes.includes(costume.id);
                    const canBuy = coins >= costume.price;
                    const isCurrent = currentCostume === costume.id;

                    return (
                      <div
                        key={costume.id}
                        onClick={() => (owned || canBuy) && buyCostume(costume.id)}
                        style={{
                          backgroundColor: isCurrent ? '#FFD700' : owned ? '#90EE90' : canBuy ? 'white' : '#D3D3D3',
                          padding: '15px',
                          borderRadius: '15px',
                          textAlign: 'center',
                          cursor: (owned || canBuy) ? 'pointer' : 'not-allowed',
                          border: isCurrent ? '4px solid #FF6347' : '3px solid #8B4513',
                          boxShadow: '0 4px 6px rgba(0,0,0,0.2)'
                        }}
                      >
                        <div style={{ fontSize: 'clamp(2rem, 8vw, 3rem)', marginBottom: '5px' }}>
                          {costume.id === 'default' ? 'ğŸ§’' : 
                           costume.id === 'superman' ? 'ğŸ¦¸' :
                           costume.id === 'spiderman' ? 'ğŸ•·ï¸' :
                           costume.id === 'hulk' ? 'ğŸ’ª' :
                           costume.id === 'thor' ? 'âš¡' :
                           costume.id === 'mario' ? 'ğŸ„' :
                           costume.id === 'batman' ? 'ğŸ¦‡' : 'ğŸ¤–'}
                        </div>
                        <div style={{ fontSize: 'clamp(0.8rem, 3vw, 1.2rem)', fontWeight: 'bold', marginBottom: '5px' }}>
                          {costume.name}
                        </div>
                        <div style={{ fontSize: 'clamp(0.7rem, 2.5vw, 1rem)', color: '#666' }}>
                          {costume.price === 0 ? 'Gratis' : `ğŸª™ ${costume.price}`}
                        </div>
                        {isCurrent && <div style={{ color: '#FF6347', fontWeight: 'bold', marginTop: '5px', fontSize: 'clamp(0.7rem, 2.5vw, 0.9rem)' }}>EQUIPADO</div>}
                        {owned && !isCurrent && <div style={{ color: '#228B22', fontWeight: 'bold', marginTop: '5px', fontSize: 'clamp(0.7rem, 2.5vw, 0.9rem)' }}>Toca para equipar</div>}
                      </div>
                    );
                  })}
                </div>

                <button
                  onClick={() => gameMode ? setScreen('game') : setScreen('menu')}
                  style={{
                    fontSize: 'clamp(1rem, 4vw, 1.5rem)',
                    padding: '15px 40px',
                    backgroundColor: '#FF6347',
                    color: 'white',
                    border: 'none',
                    borderRadius: '15px',
                    cursor: 'pointer',
                    fontWeight: 'bold',
                    marginTop: '20px'
                  }}
                >
                  {gameMode ? 'Volver al Juego' : 'Volver al MenÃº'}
                </button>
              </div>
            );
          }

          if (screen === 'game') {
            const levelData = getCurrentLevelData();
            
            return (
              <div style={{
                width: '100vw',
                height: '100vh',
                background: levelData.background,
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center',
                fontFamily: 'Arial, sans-serif',
                position: 'relative',
                overflow: 'hidden'
              }}>
                <div style={{
                  position: 'absolute',
                  top: '10px',
                  left: '10px',
                  display: 'flex',
                  gap: '10px',
                  zIndex: 100
                }}>
                  <button
                    onClick={() => setScreen('menu')}
                    style={{
                      padding: '10px 15px',
                      backgroundColor: '#FF6347',
                      color: 'white',
                      border: 'none',
                      borderRadius: '10px',
                      cursor: 'pointer',
                      fontSize: 'clamp(0.8rem, 2.5vw, 1rem)',
                      fontWeight: 'bold'
                    }}
                  >
                    ğŸ 
                  </button>
                  <button
                    onClick={() => setScreen('shop')}
                    style={{
                      padding: '10px 15px',
                      backgroundColor: '#FFA500',
                      color: 'white',
                      border: 'none',
                      borderRadius: '10px',
                      cursor: 'pointer',
                      fontSize: 'clamp(0.8rem, 2.5vw, 1rem)',
                      fontWeight: 'bold'
                    }}
                  >
                    ğŸ›ï¸
                  </button>
                </div>

                <div style={{
                  position: 'absolute',
                  top: '10px',
                  right: '10px',
                  backgroundColor: 'rgba(255,255,255,0.9)',
                  padding: '10px 15px',
                  borderRadius: '10px',
                  fontSize: 'clamp(0.9rem, 3vw, 1.3rem)',
                  fontWeight: 'bold',
                  zIndex: 100
                }}>
                  Nivel {currentLevel} | ğŸª™ {coins}
                </div>

                <canvas
                  ref={canvasRef}
                  width={800}
                  height={500}
                  style={{
                    border: '5px solid #2C5F2D',
                    borderRadius: '10px',
                    width: '100vw',
                    height: 'auto',
                    maxHeight: '60vh',
                    backgroundColor: '#8FBC8F'
                  }}
                />

                {/* CONTROLES TÃCTILES */}
                <div className="touch-controls">
                  <div className="left-controls">
                    <div 
                      className="touch-btn"
                      onTouchStart={() => touchControls.current.left = true}
                      onTouchEnd={() => touchControls.current.left = false}
                      onMouseDown={() => touchControls.current.left = true}
                      onMouseUp={() => touchControls.current.left = false}
                    >
                      â¬…ï¸
                    </div>
                    <div 
                      className="touch-btn"
                      onTouchStart={() => touchControls.current.right = true}
                      onTouchEnd={() => touchControls.current.right = false}
                      onMouseDown={() => touchControls.current.right = true}
                      onMouseUp={() => touchControls.current.right = false}
                    >
                      â¡ï¸
                    </div>
                  </div>
                  <div 
                    className="touch-btn"
                    onTouchStart={handleJump}
                    onClick={handleJump}
                  >
                    â¬†ï¸
                  </div>
                </div>

                {showLevelComplete && (
                  <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    width: '100vw',
                    height: '100vh',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                  }}>
                    <div style={{
                      backgroundColor: 'white',
                      padding: '40px',
                      borderRadius: '20px',
                      textAlign: 'center'
                    }}>
                      <h2 style={{ fontSize: 'clamp(2rem, 8vw, 3rem)', color: '#FFD700', marginBottom: '20px' }}>
                        ğŸ‰ Â¡NIVEL COMPLETADO! ğŸ‰
                      </h2>
                      <button
                        onClick={nextLevel}
                        style={{
                          fontSize: 'clamp(1.2rem, 5vw, 1.5rem)',
                          padding: '15px 40px',
                          backgroundColor: '#4CAF50',
                          color: 'white',
                          border: 'none',
                          borderRadius: '15px',
                          cursor: 'pointer',
                          fontWeight: 'bold'
                        }}
                      >
                        {currentLevel < 5 ? 'Siguiente Nivel â¡ï¸' : 'Â¡Finalizar!'}
                      </button>
                    </div>
                  </div>
                )}

                {showQuestion && currentAnimal && (
                  <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    width: '100vw',
                    height: '100vh',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000,
                    padding: '20px'
                  }}>
                    <div style={{
                      backgroundColor: 'white',
                      padding: 'clamp(20px, 5vw, 40px)',
                      borderRadius: '20px',
                      textAlign: 'center',
                      maxWidth: '90%',
                      maxHeight: '90%',
                      overflowY: 'auto'
                    }}>
                      <div style={{ fontSize: 'clamp(2.5rem, 10vw, 4rem)', marginBottom: '20px' }}>
                        {currentAnimal.name}
                      </div>

                      {showFeedback === 'correct' && (
                        <div style={{
                          fontSize: 'clamp(2rem, 8vw, 3rem)',
                          color: '#228B22',
                          fontWeight: 'bold',
                          marginBottom: '20px'
                        }}>
                          Â¡CORRECTO! ğŸ‰ +1ğŸª™
                        </div>
                      )}

                      {showFeedback && showFeedback.type === 'incorrect' && (
                        <div>
                          <div style={{
                            fontSize: 'clamp(1.5rem, 6vw, 2rem)',
                            color: '#FF6347',
                            fontWeight: 'bold',
                            marginBottom: '20px'
                          }}>
                            No es correcto ğŸ˜Š
                          </div>
                          <div style={{
                            fontSize: 'clamp(1.2rem, 5vw, 1.8rem)',
                            color: '#333',
                            marginBottom: '20px'
                          }}>
                            Respuesta correcta: <strong>{getOptionLabel(gameMode, showFeedback.correct)}</strong>
                          </div>
                        </div>
                      )}

                      {!showFeedback && (
                        <>
                          <h3 style={{ fontSize: 'clamp(1.3rem, 5vw, 2rem)', marginBottom: '30px', color: '#333' }}>
                            Â¿QuÃ© tipo de animal es?
                          </h3>

                          <div style={{
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '15px',
                            alignItems: 'center'
                          }}>
                            {gameMode === 'domestic' && (
                              <>
                                <button
                                  onClick={() => handleAnswer('domestico')}
                                  style={{
                                    fontSize: 'clamp(1.2rem, 5vw, 1.8rem)',
                                    padding: '15px 30px',
                                    backgroundColor: '#FFD700',
                                    border: '3px solid #FFA500',
                                    borderRadius: '15px',
                                    cursor: 'pointer',
                                    width: '90%',
                                    maxWidth: '300px'
                                  }}
                                >
                                  ğŸ  DomÃ©stico
                                </button>
                                <button
                                  onClick={() => handleAnswer('salvaje')}
                                  style={{
                                    fontSize: 'clamp(1.2rem, 5vw, 1.8rem)',
                                    padding: '15px 30px',
                                    backgroundColor: '#90EE90',
                                    border: '3px solid #228B22',
                                    borderRadius: '15px',
                                    cursor: 'pointer',
                                    width: '90%',
                                    maxWidth: '300px'
                                  }}
                                >
                                  ğŸŒ´ Salvaje
                                </button>
                              </>
                            )}

                            {gameMode === 'habitat' && (
                              <>
                                <button
                                  onClick={() => handleAnswer('terrestre')}
                                  style={{
                                    fontSize: 'clamp(1.2rem, 5vw, 1.8rem)',
                                    padding: '15px 30px',
                                    backgroundColor: '#D2691E',
                                    color: 'white',
                                    border: '3px solid #8B4513',
                                    borderRadius: '15px',
                                    cursor: 'pointer',
                                    width: '90%',
                                    maxWidth: '300px'
                                  }}
                                >
                                  ğŸš— Terrestre
                                </button>
                                <button
                                  onClick={() => handleAnswer('acuatico')}
                                  style={{
                                    fontSize: 'clamp(1.2rem, 5vw, 1.8rem)',
                                    padding: '15px 30px',
                                    backgroundColor: '#4682B4',
                                    color: 'white',
                                    border: '3px solid #1E3A8A',
                                    borderRadius: '15px',
                                    cursor: 'pointer',
                                    width: '90%',
                                    maxWidth: '300px'
                                  }}
                                >
                                  ğŸš¢ AcuÃ¡tico
                                </button>
                                <button
                                  onClick={() => handleAnswer('aereo')}
                                  style={{
                                    fontSize: 'clamp(1.2rem, 5vw, 1.8rem)',
                                    padding: '15px 30px',
                                    backgroundColor: '#87CEEB',
                                    border: '3px solid #4682B4',
                                    borderRadius: '15px',
                                    cursor: 'pointer',
                                    width: '90%',
                                    maxWidth: '300px'
                                  }}
                                >
                                  âœˆï¸ AÃ©reo
                                </button>
                              </>
                            )}

                            {gameMode === 'diet' && (
                              <>
                                <button
                                  onClick={() => handleAnswer('herbivoro')}
                                  style={{
                                    fontSize: 'clamp(1.2rem, 5vw, 1.8rem)',
                                    padding: '15px 30px',
                                    backgroundColor: '#90EE90',
                                    border: '3px solid #228B22',
                                    borderRadius: '15px',
                                    cursor: 'pointer',
                                    width: '90%',
                                    maxWidth: '300px'
                                  }}
                                >
                                  ğŸŒ± HerbÃ­voro
                                </button>
                                <button
                                  onClick={() => handleAnswer('carnivoro')}
                                  style={{
                                    fontSize: 'clamp(1.2rem, 5vw, 1.8rem)',
                                    padding: '15px 30px',
                                    backgroundColor: '#FF6347',
                                    color: 'white',
                                    border: '3px solid #C04030',
                                    borderRadius: '15px',
                                    cursor: 'pointer',
                                    width: '90%',
                                    maxWidth: '300px'
                                  }}
                                >
                                  ğŸ¥© CarnÃ­voro
                                </button>
                                <button
                                  onClick={() => handleAnswer('omnivoro')}
                                  style={{
                                    fontSize: 'clamp(1.2rem, 5vw, 1.8rem)',
                                    padding: '15px 30px',
                                    backgroundColor: '#FFD700',
                                    border: '3px solid #FFA500',
                                    borderRadius: '15px',
                                    cursor: 'pointer',
                                    width: '90%',
                                    maxWidth: '300px'
                                  }}
                                >
                                  ğŸ” OmnÃ­voro
                                </button>
                              </>
                            )}
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                )}
              </div>
            );
          }

          return null;
        };

        ReactDOM.render(<CapitulinGame />, document.getElementById('root'));
    </script>
</body>
</html>
